## geocoding with Google's API, ArcGIS REST API (portal provided for Stanford Affiliates), and Census Bureau's API
## Author: Ang Yu


#load the required packages
library(rgeos)
library(sp)
library(rgdal)
library(maps)
library(ggmap)
library(httr)
library(jsonlite)



# the address should not contain NA or NULL

data <- read.csv("detp.m.csv")

tobegeocoded <- data

tobegeocoded$lon <- NA
tobegeocoded$lat <- NA
tobegeocoded$tool <- NA
tobegeocoded$address <- as.character(tobegeocoded$address)
tobegeocoded$tool <- as.character(tobegeocoded$tool)

# set up the Stanford Locator

# get a token here: http://locator.stanford.edu/arcgis/tokens/

myToken <- "bpmzlSrOJdMwWTuF9PVjl3PIJqiTgaeKYBqiQnXlb1qJOig6gSB0aJxo_gPOn4ux"
source("https://raw.githubusercontent.com/cengel/ArcGIS_geocoding/master/SUL_gcFunctions.R")
stanford.geocoded <- data.frame(matrix(nrow=1,ncol=8))

# set up the census API
# benchmark = 9 means using census 2010 

get_CensusAdd <- function(address,benchmark=9){
  base <- "https://geocoding.geo.census.gov/geocoder/locations/onelineaddress?"
  soup <- GET(url=base,query=list(address=address,format='json',benchmark=benchmark))
  text <- httr::content(soup, "text", encoding="UTF-8")
  dat <- jsonlite::fromJSON(text)
  D_dat <- dat$result$addressMatches
  if (length(D_dat) > 1){
    return(D_dat['coordinates'][[1]]) #error will just return null, x[1] is lon, x[2] is lat
  }
  else {return(c(NA,NA))}
}


for(i in 1:nrow(tobegeocoded)){
  tryCatch ( {
    print(i)
    test <- NA
    attempt <- 1
    while( is.na(test) && attempt <= 4 ) {
      attempt <- attempt + 1
      result <- geocode(tobegeocoded$address[i], output = "latlona", source = "google", override_limit = T)
      test <- result[1]
    } 
    tobegeocoded$lon[i] <- as.numeric(result[1])
    tobegeocoded$lat[i] <- as.numeric(result[2])
    if (is.na(result[1])) {
      stanford.geocoded <- geocodeSL(tobegeocoded$address[i], myToken, postal = F)
      if (stanford.geocoded$status=="M") {
        tobegeocoded$lon <- stanford.geocoded$lon
        tobegeocoded$lat <- stanford.geocoded$lat
        tobegeocoded$tool[i] <- "Stanford"
      }
      else {
        tobegeocoded$lon[i] <- get_CensusAdd(tobegeocoded$address[i])[1]
        tobegeocoded$lat[i] <- get_CensusAdd(tobegeocoded$address[i])[2]
        if (tobegeocoded$lon[i]=="") {
          tobegeocoded$tool[i] <- "None"
        }
        else {tobegeocoded$tool[i] <- "Census"}
      }
    }
    else {tobegeocoded$tool[i] <- "Google"}
  }, 
  error=function(e){}
  )
  if (i%%500==0) {write.csv(tobegeocoded, "geocoding.csv", row.names = F)}
}


table(tobegeocoded$tool)

sum(is.na(tobegeocoded$lat))


write.csv(tobegeocoded, "geocoded.csv", row.names = F)
